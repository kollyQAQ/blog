[TOC]

## 并发问题

高并发三剑客、**缓存**、**降级** 和 **限流**

对于高并发的系统，有三把利器用来保护系统：**缓存**、**降级** 和 **限流**。限流常见的应用场景是秒杀、下单和评论等 **突发性** 并发问题。

1. **缓存** 的目的是提升 **系统访问速度** 和 **系统吞吐量**。
2. **降级** 是当服务 **出问题** 或者影响到核心流程的性能，则需要 **暂时屏蔽掉**，待 **高峰** 或者 **问题解决后** 再打开。
3. 有些场景并不能用 **缓存** 和 **降级** 来解决，比如稀缺资源（秒杀、抢购）、写服务（如评论、下单）、频繁的复杂查询（最新的评论）。因此需有一种手段来限制这些场景的 **并发/请求量**，即 **限流**。

https://zhuanlan.zhihu.com/p/45194014



## 如何设计一个高并发系统？

可以分为以下 6 点：

- 系统拆分
- 缓存
- MQ
- 分库分表
- 读写分离
- ElasticSearch

### ElasticSearch

Elasticsearch，简称 es。es 是分布式的，可以随便扩容，分布式天然就可以支撑高并发，因为动不动就可以扩容加机器来扛更高的并发。那么一些比较简单的查询、统计类的操作，可以考虑用 es 来承载，还有一些全文搜索类的操作，也可以考虑用 es 来承载。



## 常见的负载均衡算法有哪些、一致性哈希的一致性是什么意思、一致性哈希是如何做哈希的

轮询、加权轮询、随机、源地址 hash 

```
源地址hash法的思想是获取客户端访问的ip地址,通过hash函数计算出一个hash值,用该hash值对服
务器列表的大小进行取模运算,得到的值就是要访问的服务器的序号.

hash法的好处是,在服务器列表不变的情况下,每次客户端访问的服务器都是同一个服务器.利用这个
特性可以有状态的session会话.无需额外的操作就可以实现粘性会话.

在上面的hash算法中,存在以下的几个问题
  1.当一台服务器宕机了或者新添加一台机器之后,这个时候hashCode % servers.size()
 需要重新计算hash值, 如果在缓存的环境中,所有的请求都会涌向数据库服务
器,给数据库服务器带来巨大的压力,可能导致整个系统不可用,形成雪崩效应.

  2 .当新增了一台性能强的机器后,利用上述的hash算法无法让,新增的性能强的服务器多承担压力.

基于上面的几个问题,提出了hash算法的改进,consistent hash算法,consistent hashing
也是一种 hash 算法，简单的说，在移除 / 添加操作，它能够尽可能小的改变已存在 key 映射关系.

consistent hash算法的原理是它将hash函数的值域组织成一个
环形,整个空间按照顺时针的方式进行组织,将对应的服务器节点进行hash,将他们映射到
hash环上,假设有四台机器node1-4,hash之后如图所示:
```



## 线上问题排查

### CPU飙升原因

1. 内存泄漏，导致大量full GC
2. 代码存在死循环 （1.8 之前的HashMap 并发扩容）

### 排查思路

查找某个 Java 项目的相关线程情况 `top -Hp <pid>`

找到异常的线程 tid

拿到线程 id 的十六进制 `printf "%x" <tid> `

查看线程情况 `jstack <pid> | grep <tid>`



## 如何实现单点登录

单点登录英文全称Single Sign On，简称就是SSO。它的解释是：**在多个应用系统中，只需要登录一次，就可以访问其他相互信任的应用系统。**

### 同域下的单点登录

- 解决 cookie 不能跨域的问题
  - 我们在设置Cookie时，只能设置顶域和自己的域，不能设置其他的域
  - sso（sso.a.com）登录以后，可以将Cookie的域设置为顶域，即.a.com，这样所有子域的系统（app1.a.com和app2.a.com）都可以访问到顶域的Cookie

- 解决 session 不共享的问题
  - 通过单点 redis 存储 session 信息
  - session 共享方案，Spring-Session等

同域下的单点登录就实现了，**但这还不是真正的单点登录**

### 不同域下的单点登录

需要一个独立的认证中心，只有认证中心能接受用户的用户名密码等安全信息，其他系统不提供登录入口，只接受认证中心的间接授权。间接授权通过令牌实现，sso认证中心验证用户的用户名密码没问题，创建授权令牌，在接下来的跳转过程中，授权令牌作为参数发送给各个子系统，子系统拿到令牌，即得到了授权，可以借此创建局部会话，局部会话登录方式与单系统的登录方式相同

### 参考资料

**JWT 是什么** http://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html

**单点登录（SSO）看这一篇就够了** https://yq.aliyun.com/articles/636281

**单点登录原理与简单实现** https://www.cnblogs.com/ywlaker/p/6113927.html